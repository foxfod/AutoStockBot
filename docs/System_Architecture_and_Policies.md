# 🏗️ 시스템 아키텍처 및 상세 정책 (System Architecture & Policies)

본 문서는 자동 매매 봇의 **시스템 구조, 핵심 프로세스, 그리고 적용된 상세 매매 규칙**을 기술적으로 정리한 문서입니다.

---

## 1. 시스템 아키텍처 (System Architecture)

봇은 모듈화된 구조로 설계되어 있으며, 각 모듈이 독립적인 역할을 수행합니다.

### 📁 핵심 모듈 (`app/core`)
| 모듈명 | 역할 및 기능 |
| :--- | :--- |
| **`main_auto_trade.py`** | **컨트롤 타워**. 스케줄러를 통해 한국/미국 시장 운영 시간을 관리하고, 각 모듈을 주기적으로 호출합니다. |
| **`selector.py`** | **종목 선정기**. 시장 트렌드와 거래량을 분석하여 매수 후보(Top 10)를 발굴합니다. |
| **`market_analyst.py`** | **시장 분석기**. 네이버 금융/Yahoo 등에서 뉴스를 크롤링하고, 현재 시장의 추세(Bull/Bear)를 판단합니다. |
| **`ai_analyzer.py`** | **두뇌**. 수집된 데이터(뉴스, 차트)를 바탕으로 매수/매도/홀딩 여부를 결정하고 점수를 매깁니다. (GPT/Gemini) |
| **`trade_manager.py`** | **매매 집행기**. 실제 주문(매수/매도)을 실행하고, 잔고와 수익률을 관리하며 슬롯을 배분합니다. |
| **`kis_api.py`** | **통신**. 한국투자증권 API와 통신하여 시세 조회 및 주문을 전송합니다. |

---

## 2. 핵심 프로세스 (Core Processes)

### 🔄 1. 종목 선정 프로세스 (Selection Pipeline)
매 10분마다 실행되며, 다음 순서로 유망 종목을 필터링합니다.

1.  **후보군 수집 (Sourcing)**
    *   **Priority 0 (시장 트렌드)**: `market_analyst`가 뉴스를 분석하여 "오늘의 주도주" 5~10개를 발굴.
    *   **Priority 1 (거래량 상위)**: KIS API를 통해 전일/당일 거래량 상위 종목 조회.
2.  **기술적 1차 필터링 (Technical Filter)**
    *   **RSI**: 70 이하 (과매수 구간 진입 금지)
    *   **등락률**: 당일 +15% 이하 (이미 급등한 종목 추격 매수 방지)
    *   **추세**: 5일 이동평균선 > 20일 이동평균선 (정배열/상승추세)
3.  **AI 심층 분석 (Scoring)**
    *   뉴스 호재 여부, 차트 패턴(눌림목 등)을 종합 분석.
    *   **80점 이상**: 강력 매수 추천.
    *   **Daily Change 10% 이상**: 패널티 부여 (보수적 접근).

### ⚡ 2. 매수 집행 프로세스 (Execution)
1.  **슬롯 확인**: 최대 3개 슬롯 중 빈 자리가 있는지 확인.
2.  **자금 배분**: (예수금 / 남은 슬롯 수) 만큼 배분. (마지막 슬롯은 전액 투입)
3.  **주문 실행**: 지정가(현재가)로 주문 전송. 체결 확인.

### 🛡️ 3. 감시 및 매도 프로세스 (Monitoring & Exit)
보유 종목에 대해 1분(또는 실시간) 단위로 감시합니다.

1.  **익절 (Profit Taking)**
    *   **목표가 달성**: AI가 설정한 목표가(보통 +3~5%) 도달 시 분할/전량 매도.
    *   **트레일링 스탑 (Trailing Stop)**: 수익률 **+2%** 도달 시 활성화. 이후 고점 대비 **-1%** 하락 시 즉시 시장가 매도.
2.  **손절 (Stop Loss)**
    *   **절대 손절**: -3% (기본값) 도달 시 즉시 매도.
    *   **AI 리스크 관리**: 악재 뉴스 발생 시 AI가 "SELL" 시그널을 주면 즉시 매도.

---

## 3. 상세 정책 및 규칙 (Detailed Rules)

### 📊 매수 규칙 (Buy Rules)
*   **제외 대상**:
    *   ETF, ETN, 스팩(SPAC), 관리종목, 거래정지 종목.
    *   `KODEX`, `TIGER`, `레버리지`, `인버스` 등 키워드 포함 종목.
*   **기술적 제한**:
    *   **RSI(14)**: 70 초과 시 매수 불가 (단, 트렌드 종목은 예외 가능성 있음)
    *   **Daily Change**: +15% 초과 시 매수 불가 (Chasing High 방지)
*   **AI 점수**: 최소 70점 이상이어야 매수 검토.

### 💸 자금 관리 (Money Management)
*   **슬롯(Slot) 시스템**: 최대 **3종목**까지만 보유.
*   **분할 매수 없음**: 스캘핑 특성상 1회 진입 (단, 물타기 로직이 있을 경우 예외).
*   **미수/신용 불가**: 오직 현금(예수금) 범위 내에서만 주문.

### ⏱️ 시간 관리 (Optimized Timing)
*   **뉴스 분석 캐싱**: 트렌드 분석(`market_analyst.get_trend_candidates`)은 비용 절감을 위해 **1시간에 1회**만 수행.
*   **거래 시간**:
    *   **KR**: 09:00 ~ 15:20 (15:15 부터 청산 모드)
    *   **US**: 22:30 ~ 05:00 (04:45 부터 청산 모드)

---

## 4. 파일 및 디렉토리 구조 (Directory Structure)

```
📂 app
 ┣ 📂 core              # 핵심 로직
 ┃ ┣ 📜 main_auto_trade.py # 실행 진입점 & 스케줄러
 ┃ ┣ 📜 selector.py     # 종목 선정 (Trend + Volume)
 ┃ ┣ 📜 trade_manager.py # 매매 주문 & 잔고 관리
 ┃ ┣ 📜 ai_analyzer.py  # AI 분석 (LLM 통신)
 ┃ ┗ 📜 market_analyst.py # 뉴스 크롤링 & 시황 분석
 ┣ 📂 web               # 웹 대시보드
 ┗ 📂 utils             # 유틸리티
📂 docs                 # 문서
 ┣ 📜 Algorithm_Guide.md # 알고리즘 상세 가이드
 ┣ 📜 valid_sym_list_kr.csv # (캐시) 유효 종목 리스트
 ┗ 📜 user_manual.md    # 사용자 매뉴얼
```
