<!DOCTYPE html>
<html lang="ko" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scalping Bot Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: {
                            900: '#111827',
                            800: '#1f2937',
                            700: '#374151',
                            600: '#4b5563',
                        }
                    },
                    animation: {
                        'marquee': 'marquee 25s linear infinite',
                    },
                    keyframes: {
                        marquee: {
                            '0%': { transform: 'translateX(0%)' },
                            '100%': { transform: 'translateX(-100%)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .log-viewer::-webkit-scrollbar {
            width: 8px;
        }

        .log-viewer::-webkit-scrollbar-track {
            background: #1f2937;
        }

        .log-viewer::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }

        .log-viewer::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        /* Modal Transition */
        .modal {
            transition: opacity 0.25s ease;
        }

        .modal-body {
            transition: transform 0.25s ease;
        }

        .modal-hidden {
            opacity: 0;
            pointer-events: none;
        }

        .modal-hidden .modal-body {
            transform: scale(0.95);
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100 font-sans antialiased h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700 p-3 shadow-md flex justify-between items-center z-10">
        <div class="flex items-center space-x-3">
            <span class="text-2xl">ğŸ¤–</span>
            <h1 class="text-lg font-bold text-white tracking-wide">Scalping Bot <span class="text-blue-400">Pro</span>
            </h1>
            <button onclick="openTopPicksModal()"
                class="ml-4 px-3 py-1 bg-indigo-600 hover:bg-indigo-500 rounded text-xs font-bold text-white shadow transition flex items-center gap-1">
                ğŸ† Top 10
            </button>
        </div>

        <!-- Connection Status -->
        <div class="flex items-center space-x-4">
            <div class="flex items-center gap-2">
                <div id="connection-status" class="flex items-center space-x-2 text-xs text-red-400 font-mono">
                    <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
                    <span>ì—°ê²° ëŠê¹€</span>
                </div>
                <button onclick="connectWebSocket()" class="text-xs text-gray-500 hover:text-white transition"
                    title="Reconnect WebSocket">ğŸ”„</button>
            </div>
            <span id="server-version"
                class="text-gray-600 text-[10px] font-mono border border-gray-700 px-1 rounded">v-</span>
            <span id="server-time" class="text-gray-400 text-xs font-mono">--:--:--</span>
        </div>
    </header>

    <!-- Market Info Bar -->
    <div class="bg-gray-950 border-b border-gray-800 h-10 flex items-center overflow-hidden relative">
        <div id="market-marquee"
            class="whitespace-nowrap flex items-center gap-8 pl-4 animate-marquee hover:pause cursor-pointer text-sm font-mono">
            <!-- Market Items will be injected here -->
            <span class="text-gray-500">ì‹œì¥ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
        </div>
    </div>

    <!-- Main Layout -->
    <main class="flex-1 flex max-h-[calc(100vh-8rem)]">

        <!-- Left Column: Controls & Active Trades (60%) -->
        <div class="flex-[3] flex flex-col p-4 gap-4 overflow-y-auto border-r border-gray-800">

            <!-- Control & Status Area -->
            <div class="flex justify-between items-start gap-4">

                <!-- Bot Status -->
                <div class="flex items-center bg-gray-800 rounded-lg p-3 border border-gray-700 shadow-sm gap-4">
                    <div class="flex flex-col">
                        <span class="text-[10px] text-gray-400 uppercase tracking-wider">ìƒíƒœ</span>
                        <div id="bot-mode" class="font-bold text-sm text-yellow-500 animate-pulse">ëŒ€ê¸° ì¤‘...</div>
                    </div>
                </div>

                <!-- Control Buttons -->
                <div class="flex gap-2">
                    <button id="btn-pause" onclick="togglePause()"
                        class="px-4 py-2 bg-yellow-600 hover:bg-yellow-500 rounded text-sm font-bold shadow transition">ì¼ì‹œì •ì§€</button>
                    <button onclick="controlAction('restart')"
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded text-sm font-bold shadow transition">ì¬ì‹œì‘</button>
                    <button onclick="controlAction('shutdown')"
                        class="px-4 py-2 bg-red-600 hover:bg-red-500 rounded text-sm font-bold shadow transition">ì¢…ë£Œ</button>
                </div>
            </div>

            <!-- Slot Management Cards -->
            <div class="grid grid-cols-2 gap-4">
                <!-- KR Slots -->
                <!-- KR Slots -->
                <div id="kr-slot-box" onclick="filterTrades('KR')"
                    class="bg-gray-800 rounded-lg p-3 border border-gray-700 shadow-sm transition hover:border-gray-600 cursor-pointer">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center gap-2">
                            <span
                                class="text-xs font-bold text-yellow-400 bg-gray-900 border border-gray-700 px-1 py-0.5 rounded">KR</span>
                            <span class="text-xs text-gray-400">ìŠ¬ë¡¯</span>
                        </div>
                        <span id="kr-budget" class="text-xs font-mono text-gray-300">â‚©0</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="updateSlots('KR', -1)"
                            class="w-6 h-6 flex items-center justify-center bg-gray-700 hover:bg-gray-600 rounded text-gray-300 transition">-</button>
                        <div id="kr-slots-container" class="flex-1 flex gap-1 h-6">
                            <!-- Slot Boxes -->
                        </div>
                        <button onclick="updateSlots('KR', 1)"
                            class="w-6 h-6 flex items-center justify-center bg-gray-700 hover:bg-gray-600 rounded text-gray-300 transition">+</button>
                    </div>
                </div>

                <!-- US Slots -->
                <!-- US Slots -->
                <div id="us-slot-box" onclick="filterTrades('US')"
                    class="bg-gray-800 rounded-lg p-3 border border-gray-700 shadow-sm transition hover:border-gray-600 cursor-pointer">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center gap-2">
                            <span
                                class="text-xs font-bold text-blue-400 bg-gray-900 border border-gray-700 px-1 py-0.5 rounded">US</span>
                            <span class="text-xs text-gray-400">ìŠ¬ë¡¯</span>
                        </div>
                        <span id="us-budget" class="text-xs font-mono text-gray-300">$0.00</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="updateSlots('US', -1)"
                            class="w-6 h-6 flex items-center justify-center bg-gray-700 hover:bg-gray-600 rounded text-gray-300 transition">-</button>
                        <div id="us-slots-container" class="flex-1 flex gap-1 h-6">
                            <!-- Slot Boxes -->
                        </div>
                        <button onclick="updateSlots('US', 1)"
                            class="w-6 h-6 flex items-center justify-center bg-gray-700 hover:bg-gray-600 rounded text-gray-300 transition">+</button>
                    </div>
                </div>
            </div>

            <!-- Active Positions Grid -->
            <div class="flex-1 flex flex-col min-h-0">
                <h2 class="text-sm font-semibold text-gray-300 mb-2 flex items-center gap-2">
                    <h2 class="text-sm font-semibold text-gray-300 mb-2 flex items-center gap-2">
                        <span id="grid-title">ë³´ìœ  ì¢…ëª© í˜„í™©</span>
                        <span id="active-count"
                            class="bg-gray-700 text-gray-300 text-[10px] px-1.5 py-0.5 rounded-full">0</span>
                    </h2>
                    <div id="active-trades-grid"
                        class="flex-1 grid grid-cols-1 xl:grid-cols-2 gap-3 overflow-y-auto pr-1">
                        <!-- Cards -->
                        <div class="col-span-full text-center text-gray-600 py-10 text-sm">ë³´ìœ  ì¤‘ì¸ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤</div>
                    </div>
            </div>

        </div>

        <!-- Right Column: Logs (40%) -->
        <div class="flex-[2] flex flex-col bg-gray-950 min-w-0">
            <div
                class="bg-gray-900 px-3 py-2 text-xs text-gray-400 border-b border-gray-800 flex justify-between items-center">
                <span>ì‹¤ì‹œê°„ ë¡œê·¸</span>
                <button onclick="clearLogs()" class="hover:text-white px-2">ì§€ìš°ê¸°</button>
            </div>
            <div id="log-container" class="log-viewer flex-1 overflow-y-auto p-3 font-mono text-xs leading-5">
                <!-- Logs -->
                <div class="text-gray-700 italic">Waiting for logs...</div>
            </div>
        </div>

    </main>

    <!-- Trade Detail Modal -->
    <div id="trade-modal"
        class="modal modal-hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4">
        <div
            class="modal-body bg-gray-800 w-full max-w-md rounded-xl border border-gray-700 shadow-2xl flex flex-col overflow-hidden">
            <!-- Header -->
            <div class="bg-gray-900 px-4 py-3 border-b border-gray-700 flex justify-between items-center">
                <div class="flex flex-col">
                    <h3 id="modal-title" class="text-lg font-bold text-white">Stock Name</h3>
                    <span id="modal-symbol" class="text-xs text-gray-400">SYMBOL</span>
                </div>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white text-xl">&times;</button>
            </div>

            <!-- Content -->
            <div class="p-4 space-y-4">
                <!-- Main Stats -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-700/50 p-3 rounded">
                        <span class="block text-xs text-gray-400">ìˆ˜ìµë¥ </span>
                        <span id="modal-pnl" class="block text-2xl font-bold text-green-400">+0.00%</span>
                    </div>
                    <div class="bg-gray-700/50 p-3 rounded">
                        <span class="block text-xs text-gray-400">í‰ê°€ê¸ˆì•¡</span>
                        <span id="modal-value" class="block text-xl font-bold text-white">$0.00</span>
                        <span id="modal-value-krw" class="block text-[10px] text-gray-500">â‰ˆ â‚©0</span>
                    </div>
                </div>

                <!-- Detailed Info -->
                <div class="text-sm space-y-2 border-t border-gray-700 pt-3">
                    <div class="flex justify-between"><span>í˜„ì¬ê°€:</span> <span id="modal-price"
                            class="font-mono text-white">0</span></div>
                    <div class="flex justify-between"><span>í‰ë‹¨ê°€:</span> <span id="modal-buy-price"
                            class="font-mono text-gray-300">0</span></div>
                    <div class="flex justify-between"><span>ë³´ìœ ìˆ˜ëŸ‰:</span> <span id="modal-qty"
                            class="font-mono text-gray-300">0</span></div>
                    <div class="flex justify-between text-yellow-400"><span>í‰ê°€ì†ìµ:</span> <span id="modal-profit-amt"
                            class="font-mono">0</span></div>
                </div>

                <!-- Settings Edit -->
                <div class="bg-gray-900/50 p-3 rounded border border-gray-700 space-y-3">
                    <div class="flex items-center gap-2">
                        <label class="text-xs text-gray-400 w-20">ëª©í‘œê°€ (%)</label>
                        <input id="input-target" type="number" step="0.1"
                            class="flex-1 bg-gray-800 border-gray-600 rounded text-xs px-2 py-1 focus:ring-1 focus:ring-blue-500 outline-none"
                            placeholder="e.g. 3.0" oninput="calcPricePreview('target')">
                        <span id="preview-target" class="text-[10px] text-gray-500 w-20 text-right"></span>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-xs text-gray-400 w-20">ì†ì ˆê°€ (%)</label>
                        <input id="input-stop" type="number" step="0.1"
                            class="flex-1 bg-gray-800 border-gray-600 rounded text-xs px-2 py-1 focus:ring-1 focus:ring-red-500 outline-none"
                            placeholder="e.g. 2.0" oninput="calcPricePreview('stop')">
                        <span id="preview-stop" class="text-[10px] text-gray-500 w-20 text-right"></span>
                    </div>
                    <button onclick="updateTradeSettings()"
                        class="w-full py-1.5 bg-blue-600 hover:bg-blue-500 rounded text-xs font-bold transition">ì„¤ì •
                        ì—…ë°ì´íŠ¸</button>
                    <!-- <p class="text-[10px] text-gray-500 text-center">Enter percentages (e.g. 3.0 for 3%)</p> -->
                </div>

                <!-- Analysis Button -->
                <button onclick="analyzeStock()"
                    class="w-full py-2 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 rounded text-sm font-bold text-white shadow-lg flex justify-center items-center gap-2">
                    âœ¨ AI ì¢…ëª© ë¶„ì„ ë¦¬í¬íŠ¸ í™•ì¸
                </button>
                <div id="analysis-result"
                    class="hidden bg-gray-900 p-3 rounded text-xs text-gray-300 max-h-40 overflow-y-auto border border-gray-700 whitespace-pre-wrap">
                </div>

            </div>

            <!-- Footer Actions -->
            <div class="bg-gray-900 px-4 py-3 flex gap-3">
                <button onclick="sellTrade()"
                    class="flex-1 py-2 bg-red-600 hover:bg-red-500 rounded text-sm font-bold text-white transition flex items-center justify-center gap-2">
                    ğŸš¨ ì „ëŸ‰ ë§¤ë„ (ì‹œì¥ê°€)
                </button>
            </div>
        </div>
    </div>

    <!-- Top 10 Modal -->
    <div id="top-picks-modal"
        class="modal modal-hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4">
        <div
            class="modal-body bg-gray-800 w-full max-w-2xl rounded-xl border border-gray-700 shadow-2xl flex flex-col max-h-[90vh]">
            <div class="bg-gray-900 px-4 py-3 border-b border-gray-700 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <h3 class="text-lg font-bold text-white">ğŸ† ì˜¤ëŠ˜ì˜ Top 10</h3>
                    <span id="top-picks-date"
                        class="text-xs text-gray-400 bg-gray-800 px-2 py-0.5 rounded border border-gray-700">DATE</span>
                </div>
                <button onclick="closeTopPicksModal()" class="text-gray-400 hover:text-white text-xl">&times;</button>
            </div>
            <div id="top-picks-list" class="flex-1 overflow-y-auto p-4 space-y-2">
                <!-- Content -->
                <div class="text-center text-gray-500 py-10">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
            <div class="bg-gray-900 px-4 py-3 border-t border-gray-700 flex justify-end gap-2">
                <button onclick="refreshTopPicks('KR')"
                    class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-xs text-white transition flex items-center gap-1">
                    ğŸ”„ KR ê°±ì‹ 
                </button>
                <button onclick="refreshTopPicks('US')"
                    class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-xs text-white transition flex items-center gap-1">
                    ğŸ”„ US ê°±ì‹ 
                </button>
                <button onclick="closeTopPicksModal()"
                    class="px-4 py-1.5 bg-gray-600 hover:bg-gray-500 rounded text-xs font-bold text-white transition">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- Connection Lost Overlay -->
    <div id="connection-lost"
        class="fixed inset-0 bg-black/90 flex flex-col items-center justify-center z-[100] hidden">
        <div class="text-red-500 text-4xl mb-4 animate-bounce">âš ï¸</div>
        <h2 class="text-xl font-bold text-white mb-2">Connection Lost</h2>
        <p class="text-gray-400 mb-6 text-sm">Attempting to reconnect...</p>
        <button onclick="location.reload()"
            class="px-5 py-2 bg-blue-600 hover:bg-blue-500 rounded text-white text-sm font-bold transition">Reload
            Now</button>
    </div>

    <script>
        // --- Global State ---
        let currentTrades = {};
        let currentSymbol = null; // For Modal
        let manualSlots = {}; // {KR: 3, US: 2}
        let currentFilter = 'ALL'; // 'ALL', 'KR', 'US'

        // Helper Functions
        const fmt = (n) => n ? n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0.00';
        const fmtKrw = (n) => n ? n.toLocaleString('ko-KR') : '0';

        async function fetchState() {
            try {
                const res = await fetch('/api/state');
                const data = await res.json();
                if (data.status === 'loading') return;

                // 1. Top Bar
                document.getElementById('server-time').innerText = data.server_time.split(' ')[1];
                if (data.version) document.getElementById('server-version').innerText = `v${data.version}`;

                // 2. Budget
                if (data.kr_budget !== undefined) document.getElementById('kr-budget').innerText = `â‚©${fmtKrw(data.kr_budget)}`;
                if (data.us_budget !== undefined) document.getElementById('us-budget').innerText = `$${fmt(data.us_budget)}`;

                // 3. Active Trades
                currentTrades = data.active_trades || {};
                renderTrades(currentTrades);
                document.getElementById('active-count').innerText = Object.keys(currentTrades).length;

            } catch (e) {
                console.error("State fetch error", e);
            }
        }

        function filterTrades(filter) {
            currentFilter = filter;
            renderTrades(currentTrades);

            // Visual Feedback
            const krBox = document.getElementById('kr-slot-box');
            const usBox = document.getElementById('us-slot-box');

            // Reset
            krBox.classList.remove('ring-2', 'ring-blue-500');
            usBox.classList.remove('ring-2', 'ring-blue-500');

            if (filter === 'KR') {
                krBox.classList.add('ring-2', 'ring-blue-500');
            } else if (filter === 'US') {
                usBox.classList.add('ring-2', 'ring-blue-500');
            }
        }

        function renderTrades(trades) {
            const container = document.getElementById('active-trades-grid');
            let list = Object.entries(trades);

            // Filter
            if (currentFilter !== 'ALL') {
                list = list.filter(([_, t]) => {
                    const mType = t.market_type || 'KR';
                    return mType === currentFilter;
                });
            }

            if (list.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center text-gray-600 py-10 text-sm">
                    ${currentFilter === 'ALL' ? 'ë³´ìœ  ì¤‘ì¸ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤' : currentFilter + ' ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤'}
                </div>`;
                return;
            }

            container.innerHTML = list.map(([sym, t]) => {
                const isUS = t.market_type === 'US';
                const pnlClass = t.profit_rate > 0 ? 'text-red-400' : 'text-blue-400';
                const pnlBg = t.profit_rate > 0 ? 'bg-red-500/10 border-red-500/30' : 'bg-blue-500/10 border-blue-500/30';

                return `
                    <div onclick="openModal('${sym}')" class="bg-gray-800 rounded border border-gray-700 hover:border-gray-500 p-3 cursor-pointer transition relative overflow-hidden group">
                        <div class="absolute inset-0 ${pnlBg} opacity-50 group-hover:opacity-60 transition"></div>
                        <div class="relative flex justify-between items-center z-10">
                            <div>
                                <div class="flex items-center gap-2">
                                    <span class="font-bold text-white text-base">${t.name}</span>
                                    <span class="text-[10px] bg-gray-900/50 px-1 rounded text-gray-300">${sym}</span>
                                    ${t.trailing_active ? '<span class="text-[10px] bg-yellow-600 text-white px-1 rounded animate-pulse" title="Trailing Stop Active">Trailing</span>' : ''}
                                </div>
                                <div class="text-xs text-gray-300 mt-1">
                                    <span class="opacity-70">Buy: </span>${isUS ? '$' : ''}${fmt(t.buy_price)}
                                    <span class="mx-1">â€¢</span>
                                    <span class="opacity-70">Qty: </span>${t.quantity}
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-lg ${pnlClass}" title="Total P&L">${t.profit_rate.toFixed(2)}%</div>
                                <div class="text-[10px] ${t.daily_change > 0 ? 'text-red-400' : 'text-blue-400'} mb-0.5" title="Daily Change">
                                    (${t.daily_change > 0 ? '+' : ''}${t.daily_change ? t.daily_change.toFixed(2) : '0.00'}%)
                                </div>
                                <div class="text-xs text-gray-300">
                                    ${isUS ? '$' : ''}${fmt(t.current_price)}
                                </div>
                                ${isUS ? `<div class="text-[10px] text-gray-500">â‰ˆ â‚©${fmtKrw(t.value_krw)}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterTrades(market) {
            currentFilter = market;

            // Update UI Highlights
            document.getElementById('kr-slot-box').className = `bg-gray-800 rounded-lg p-3 border shadow-sm cursor-pointer transition ${market === 'KR' ? 'border-blue-500 ring-1 ring-blue-500' : 'border-gray-700 hover:border-gray-600'}`;
            document.getElementById('us-slot-box').className = `bg-gray-800 rounded-lg p-3 border shadow-sm cursor-pointer transition ${market === 'US' ? 'border-blue-500 ring-1 ring-blue-500' : 'border-gray-700 hover:border-gray-600'}`;

            // Re-render
            renderTrades(currentTrades);

            // Update Title
            const titleMap = { 'ALL': 'ë³´ìœ  ì¢…ëª© í˜„í™©', 'KR': 'ë³´ìœ  ì¢…ëª© í˜„í™© (í•œêµ­)', 'US': 'ë³´ìœ  ì¢…ëª© í˜„í™© (ë¯¸êµ­)' };
            document.getElementById('grid-title').innerText = titleMap[market];
        }

        // --- Actions ---
        async function controlAction(action) {
            const actionName = {
                'restart': 'ì¬ì‹œì‘',
                'shutdown': 'ì¢…ë£Œ'
            }[action] || action;
            if (!confirm(`${actionName} í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            await fetch(`/api/control/${action}`, { method: 'POST' });
        }
        async function togglePause() {
            const btn = document.getElementById('btn-pause');
            const isPaused = btn.innerText.includes('Resume');
            await fetch(`/api/control/${isPaused ? 'resume' : 'pause'}`, { method: 'POST' });
        }

        async function updateSlots(market, change) {
            // Optimistic Update
            let current = (manualSlots[market] || 3);
            let next = current + change;
            if (next < 1 || next > 10) return;
            manualSlots[market] = next; // Immediate visual feedback

            try {
                await fetch('/api/config/slots', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ market, count: next })
                });
            } catch (e) {
                console.error("Slot update failed", e);
            }
        }

        // --- Modal ---
        function openModal(symbol) {
            const t = currentTrades[symbol];
            if (!t) return;
            currentSymbol = symbol;

            const isUS = t.market_type === 'US';
            const pnlClass = t.profit_rate > 0 ? 'text-green-400' : 'text-red-400';

            // Use values from backend, or calculate default target/stop for display if missing
            const targetP = t.target_price
                ? ((t.target_price - t.buy_price) / t.buy_price * 100).toFixed(1)
                : '3.0';
            const stopP = t.stop_loss_price
                ? ((t.buy_price - t.stop_loss_price) / t.buy_price * 100).toFixed(1)
                : '2.0';

            document.getElementById('modal-title').innerText = t.name;
            document.getElementById('modal-symbol').innerText = symbol + (isUS ? ' (US)' : ' (KR)');

            document.getElementById('modal-pnl').innerText = `${t.profit_rate > 0 ? '+' : ''}${t.profit_rate.toFixed(2)}%`;
            document.getElementById('modal-pnl').className = `block text-2xl font-bold ${pnlClass}`;

            document.getElementById('modal-value').innerText = `${isUS ? '$' : ''}${fmt(t.value)}`;
            document.getElementById('modal-value-krw').innerText = isUS ? `â‰ˆ â‚©${fmtKrw(t.value_krw)}` : `â‚©${fmtKrw(t.value)}`;

            document.getElementById('modal-price').innerText = `${isUS ? '$' : ''}${fmt(t.current_price)}`;
            document.getElementById('modal-buy-price').innerText = `${isUS ? '$' : ''}${fmt(t.buy_price)}`;
            document.getElementById('modal-qty').innerText = t.quantity;

            const profitAmt = t.profit_amount || 0;
            document.getElementById('modal-profit-amt').innerText = `${profitAmt > 0 ? '+' : ''}${isUS ? '$' : ''}${fmt(profitAmt)}`;
            document.getElementById('modal-profit-amt').className = `font-mono ${profitAmt > 0 ? 'text-green-400' : 'text-red-400'}`;

            // Inputs (Display percentages)
            document.getElementById('input-target').value = targetP;
            document.getElementById('input-stop').value = stopP;

            // Update Previews
            calcPricePreview('target');
            calcPricePreview('stop');

            // Reset or Load Analysis Result
            const resultArea = document.getElementById('analysis-result');
            if (analysisCache[symbol]) {
                resultArea.classList.remove('hidden');
                resultArea.innerHTML = analysisCache[symbol];
                resultArea.innerHTML += "\n\n<span class='text-gray-500 text-[10px]'>â€» ìµœì‹  ë¶„ì„ì´ í•„ìš”í•˜ë©´ ë²„íŠ¼ì„ ë‹¤ì‹œ ëˆŒëŸ¬ì£¼ì„¸ìš”.</span>";
            } else {
                resultArea.classList.add('hidden');
                resultArea.innerText = '';
            }

            modal.classList.remove('modal-hidden');
        }

        function closeModal() {
            modal.classList.add('modal-hidden');
            currentSymbol = null;
            // Clear analysis view to prevent flickering
            document.getElementById('analysis-result').innerHTML = '';
            document.getElementById('analysis-result').classList.add('hidden');
        }

        async function updateTradeSettings() {
            if (!currentSymbol) return;
            const t = currentTrades[currentSymbol];
            const targetPct = parseFloat(document.getElementById('input-target').value);
            const stopPct = parseFloat(document.getElementById('input-stop').value);

            if (isNaN(targetPct) || isNaN(stopPct)) {
                alert("ìœ íš¨í•œ í¼ì„¼íŠ¸ ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            // Calculate actual prices from percentages
            const targetPrice = t.buy_price * (1 + targetPct / 100);
            const stopLossPrice = t.buy_price * (1 - stopPct / 100);

            try {
                const res = await fetch(`/api/trade/${currentSymbol}/update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        target_price: targetPrice,
                        stop_loss_price: stopLossPrice
                    })
                });
                if (res.ok) {
                    alert('ì„¤ì • ì—…ë°ì´íŠ¸ ì™„ë£Œ!');
                    closeModal();
                } else {
                    alert('ì„¤ì • ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
                }
            } catch (e) { console.error(e); alert('ì„¤ì • ì—…ë°ì´íŠ¸ ì˜¤ë¥˜'); }
        }

        async function sellTrade() {
            if (!currentSymbol || !confirm(`${currentSymbol} ì¢…ëª©ì„ ì‹œì¥ê°€ë¡œ ì „ëŸ‰ ë§¤ë„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            try {
                // Determine market type from currentTrades
                const type = currentTrades[currentSymbol].market_type;
                const url = `/api/trade/${currentSymbol}/sell?market_type=${type}`;
                const res = await fetch(url, { method: 'POST' });
                const data = await res.json();

                if (res.ok) {
                    alert("ë§¤ë„ ì£¼ë¬¸ ì™„ë£Œ: " + data.message);
                    closeModal();
                } else {
                    alert("ë§¤ë„ ì‹¤íŒ¨: " + data.detail);
                }
            } catch (e) { console.error(e); alert('ë§¤ë„ ìš”ì²­ ì¤‘ ì—ëŸ¬ ë°œìƒ'); }
        }

        // Analysis Cache
        const analysisCache = {};

        async function analyzeStock() {
            if (!currentSymbol) return;

            const btn = document.querySelector('button[onclick="analyzeStock()"]');
            const resultArea = document.getElementById('analysis-result');

            // UI Loading State
            const originalText = btn.innerHTML;
            btn.innerHTML = `<span class="animate-spin">âŒ›</span> ë¶„ì„ ì¤‘...`;
            btn.disabled = true;
            resultArea.classList.add('hidden');
            resultArea.innerText = '';

            try {
                const res = await fetch(`/api/analyze/${currentSymbol}`, { method: 'POST' });
                const data = await res.json();

                resultArea.classList.remove('hidden');
                if (data.result) {
                    // Cache the result
                    analysisCache[currentSymbol] = data.result;
                    // Display result
                    resultArea.innerHTML = data.result; // Use innerHTML to render line breaks if any
                    // Add re-analyze hint
                    resultArea.innerHTML += "\n\n<span class='text-gray-500'>Make sure to click the button again if you want a fresh analysis.</span>";
                } else {
                    resultArea.innerText = "ë¶„ì„ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
                }
            } catch (e) {
                console.error(e);
                alert("ë¶„ì„ ìš”ì²­ ì‹¤íŒ¨");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function calcPricePreview(type) {
            if (!currentSymbol || !currentTrades[currentSymbol]) return;

            const t = currentTrades[currentSymbol];
            const buyPrice = t.buy_price;

            if (type === 'target') {
                const val = parseFloat(document.getElementById('input-target').value);
                const span = document.getElementById('preview-target');
                if (!isNaN(val)) {
                    const price = buyPrice * (1 + val / 100);
                    span.innerText = `${t.market_type === 'US' ? '$' : ''}${fmt(price)}`;
                } else {
                    span.innerText = '';
                }
            } else if (type === 'stop') {
                const val = parseFloat(document.getElementById('input-stop').value);
                const span = document.getElementById('preview-stop');
                if (!isNaN(val)) {
                    const price = buyPrice * (1 - val / 100);
                    span.innerText = `${t.market_type === 'US' ? '$' : ''}${fmt(price)}`;
                } else {
                    span.innerText = '';
                }
            }
        }

        // --- WebSocket ---
        let ws = null;
        let reconnectTimer = null;

        function connectWebSocket() {
            // UI Loading State (Optional: Only if triggered by button)
            const btn = document.querySelector('button[title="Reconnect WebSocket"]');
            if (btn) {
                btn.innerHTML = '<span class="animate-spin inline-block">ğŸ”„</span>';
                btn.disabled = true;
            }

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/logs`;

            // Cleanup existing connection
            if (ws) {
                ws.onclose = null; // Prevent trigger loop during manual close
                ws.close();
            }
            if (reconnectTimer) clearTimeout(reconnectTimer);

            ws = new WebSocket(wsUrl);
            const statusEl = document.getElementById('connection-status');
            const overlay = document.getElementById('connection-lost');

            ws.onopen = () => {
                statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500"></span><span class="text-green-400">Connected</span>';
                overlay.classList.add('hidden');
                addLog({ data: { timestamp: new Date().toLocaleTimeString(), level: 'SYSTEM', message: 'Connected to Live Stream' } });

                // Reset Button
                if (btn) {
                    btn.innerHTML = 'ğŸ”„';
                    btn.disabled = false;
                }
            };
            ws.onmessage = (e) => {
                const payload = JSON.parse(e.data);
                if (payload.type === 'log') addLog(payload);
            };
            ws.onclose = () => {
                statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span><span>ì—°ê²° ëŠê¹€</span>';

                if (btn) {
                    btn.innerHTML = 'ğŸ”„';
                    btn.disabled = false;
                }

                // Auto Reconnect
                reconnectTimer = setTimeout(connectWebSocket, 3000);
            };
            ws.onerror = () => {
                console.error("WS Error");
                ws.close();
            };
        }

        function addLog(payload) {
            const data = payload.data;
            const div = document.createElement('div');
            let color = 'text-gray-300';
            if (data.level === 'ERROR') color = 'text-red-400 font-bold';
            if (data.level === 'WARNING') color = 'text-yellow-400';
            if (data.level === 'INFO') color = 'text-blue-300';
            if (data.level === 'SYSTEM') color = 'text-purple-400';

            div.className = `break-words ${color} mb-1`;
            div.innerHTML = `<span class="text-[10px] opacity-40 mr-1">[${data.timestamp}]</span>${data.message}`;
            logContainer.appendChild(div);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        function clearLogs() { logContainer.innerHTML = ''; }

        // Init
        const inputTarget = document.getElementById('input-target');
        const inputStop = document.getElementById('input-stop');
        const logContainer = document.getElementById('log-container');

        // Connect
        connectWebSocket();
        setInterval(fetchState, 2000);

        // Initial Fetch
        fetchState();

        const modal = document.getElementById('trade-modal');
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

        // --- Top 10 Modal ---
        const topPicksModal = document.getElementById('top-picks-modal');

        async function openTopPicksModal() {
            topPicksModal.classList.remove('modal-hidden');
            await loadTopPicks();
        }

        function closeTopPicksModal() {
            topPicksModal.classList.add('modal-hidden');
        }

        async function loadTopPicks() {
            const listContainer = document.getElementById('top-picks-list');
            try {
                const res = await fetch('/api/top-picks');
                const data = await res.json();

                if (!data.picks || data.picks.length === 0) {
                    listContainer.innerHTML = '<div class="text-center text-gray-500 py-10">ì•„ì§ ì„ ì •ëœ Top 10 ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.<br>ê°±ì‹  ë²„íŠ¼ì„ ëˆŒëŸ¬ ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”.</div>';
                    document.getElementById('top-picks-date').innerText = new Date().toLocaleDateString();
                    return;
                }

                document.getElementById('top-picks-date').innerText = `${data.date} (${data.market})`;

                listContainer.innerHTML = data.picks.map((p, i) => `
                    <div class="bg-gray-700/50 p-3 rounded border border-gray-700 flex flex-col gap-2">
                        <div class="flex justify-between items-start">
                            <div class="flex items-center gap-2">
                                <span class="bg-blue-600 text-white text-[10px] font-bold px-1.5 rounded">${i + 1}</span>
                                <span class="font-bold text-white">${p.name}</span>
                                <span class="text-xs text-gray-400">(${p.symbol})</span>
                            </div>
                            <span class="text-yellow-400 font-bold text-sm">${p.score}ì </span>
                        </div>
                        <div class="text-xs text-gray-300 bg-gray-900/50 p-2 rounded">
                            ${p.reason}
                        </div>
                    </div>
                `).join('');

            } catch (e) {
                console.error(e);
                listContainer.innerHTML = '<div class="text-center text-red-500 py-10">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>';
            }
        }

        async function refreshTopPicks(market) {
            if (!confirm(`${market} ì‹œì¥ ë¶„ì„ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì•½ 1~2ë¶„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤)`)) return;

            const listContainer = document.getElementById('top-picks-list');
            listContainer.innerHTML = '<div class="text-center text-gray-400 py-10 flex flex-col items-center gap-2"><span class="text-2xl animate-spin">â³</span><span>AIê°€ ì‹¬ì¸µ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</span></div>';

            try {
                const res = await fetch('/api/top-picks/refresh', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ market })
                });
                const data = await res.json();
                await loadTopPicks(); // Reload logic handles display
            } catch (e) {
                console.error(e);
                listContainer.innerHTML = '<div class="text-center text-red-500 py-10">ë¶„ì„ ìš”ì²­ ì‹¤íŒ¨</div>';
            }
        }

        topPicksModal.addEventListener('click', (e) => {
            if (e.target === topPicksModal) closeTopPicksModal();
        });

    </script>
</body>

</html>